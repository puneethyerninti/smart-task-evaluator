## Smart Task Evaluator

Full-stack SaaS starter that lets authenticated users submit coding tasks, trigger AI-powered evaluations (OpenAI), and unlock full reports via Stripe Checkout. Supabase handles auth/Postgres/Edge Functions.

### Features

- Email/password signup + login flows powered by Supabase Auth
- Dashboard summarizing submissions, statuses, and recent reports
- Task submission form with language selection and Supabase-backed queueing
- AI evaluation via OpenAI Responses API + Supabase Edge Function (`run-evaluation`)
- Report detail UI with strengths/improvements plus paywall state
- Billing page that lists locked reports and launches Stripe Checkout
- Stripe webhook to persist payments and unlock full reports automatically

### Stack

- Next.js 16 App Router (React 19, Tailwind 4)
- Supabase Auth + Postgres + Edge Functions (Deno)
- Stripe Checkout + webhooks
- OpenAI Responses API

### Prerequisites

- Node.js 20+
- Supabase project with `tasks`, `reports`, `payments` tables and the `run-evaluation` Edge Function deployed
- Stripe account + test mode keys
- OpenAI API key (Responses API access)

### Environment

Copy `.env.example` to `.env.local` and fill in real values:

```
cp .env.example .env.local
```

Required variables:

- `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`
- `NEXT_PUBLIC_SUPABASE_FUNCTIONS_URL`
- `OPENAI_API_KEY`, optional `OPENAI_MODEL`
- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`, `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`
- `NEXT_PUBLIC_REPORT_PRICE_CENTS`, `NEXT_PUBLIC_APP_URL`, `STRIPE_CURRENCY`
- `NEXT_DISABLE_TURBOPACK=1` (already handled by `npm run dev`)

### Database schema (Supabase)

Run the following SQL snippet in the Supabase SQL editor to provision the three required tables (tasks, reports, payments) and to ensure the `language` + `status` columns exist:

```sql
create extension if not exists "uuid-ossp";

create table if not exists public.tasks (
	id uuid primary key default uuid_generate_v4(),
	user_id uuid references auth.users(id) on delete cascade,
	title text not null,
	description text not null,
	code text not null,
	language text default 'unspecified',
	status text default 'pending',
	created_at timestamptz default now()
);

alter table public.tasks
	add column if not exists language text default 'unspecified',
	add column if not exists status text default 'pending';

create table if not exists public.reports (
	id uuid primary key default uuid_generate_v4(),
	task_id uuid references public.tasks(id) on delete cascade,
	user_id uuid references auth.users(id) on delete cascade,
	score int,
	strengths text[],
	improvements text[],
	short_feedback text,
	full_report text,
	unlocked boolean default false,
	created_at timestamptz default now()
);

create table if not exists public.payments (
	id uuid primary key default uuid_generate_v4(),
	user_id uuid references auth.users(id) on delete cascade,
	report_id uuid references public.reports(id) on delete cascade,
	stripe_session_id text,
	stripe_payment_id text,
	amount numeric,
	currency text,
	status text,
	created_at timestamptz default now()
);
```

Row Level Security (RLS) should stay enabled with policies matching your auth model (e.g., users can read/write only their rows). Update the policies after running the SQL if you use custom schemas.

### Development

Install dependencies and run the dev server (Turbopack disabled to avoid Supabase source map issues):

```bash
npm install
npm run dev
```

Visit `http://localhost:3000`.

### Supabase helpers

- `lib/supabase/server.ts` – memoized `createServerComponentClient` for App Router server components
- `lib/supabase/client.ts` – `createClientComponentClient` for client components/hooks
- `lib/supabase/api.ts` – `createRouteHandlerClient` wrapper for App Router route handlers

Use the appropriate helper per environment to ensure cookies/session handling works with Next.js 15/16.

### Stripe webhook

Configure the webhook endpoint at `/api/stripe/webhook` and set `STRIPE_WEBHOOK_SECRET`. Successful payments unlock the corresponding `reports` row, while `/api/payments/checkout` plus `/billing` provide the user-facing purchase flow.

### Supabase Edge Function

`supabase/functions/run-evaluation` is a Deno function that fetches a task, calls OpenAI, and stores a locked report. Deploy with:

```
supabase functions serve run-evaluation --env-file supabase/.env
supabase functions deploy run-evaluation
```
